---
title: "ASA_FooDB_Food_Matrix"
author: "Stephanie Wilson"
date: "`r Sys.Date()`"
output: html_document
---

#  Food Matrix Classifications

__Required Input Files__.                          
  - *ingredientized_asa_10-2022.csv* - Output from 04_ingredientize_merge.rmd script, 'Ingredientized' Quality Controlled ASA24 Recall Data from FL100 Study.  
  - *WWEIA_Category_codes.csv* - Food classification codes from [WWEIA 2017-2018](https://www.ars.usda.gov/ARSUserFiles/80400530/pdf/1718/Food_categories_2017-2018.pdf), Clear Food Matrix Classification Manually Added
  - *codematched_final.csv*
  
__Information__. 
This script helps curate classifications of FoodCodes in ASA24/FNDDS into liquids, semi-solids, and solids. FoodCodes were used instead of Ingredient Codes to reflect the true nature of the dish consumed by participants.

__Output__. 
  - *ASA_FooDB_Food_Matrix.csv* - Contains Food Matrix Classification for each food.
  
```{r message=FALSE}
library(tidyverse)
```


```{r Load Data}
#Ingredientized ASA
ingredients = read.csv('Ingredientize/data/ingredientized_asa_10-2022.csv') %>%
  select(-c(WWEIA.Category.description, UserID, EatWith)) %>%
  select(-(KCAL:D_CHEESE)) # remove ASA nutrient information

# WWEIA Category Codes with Food Classificiations
WWEIAcodes = read.csv('data/WWEIA_Category_Codes.csv', row.names = 1) %>%
  rename('Category' = 'WWEIA.Category.description')

#Ingredientized ASA codes matched to FooDB
matched = read.csv('data/codematched_final.csv') %>%
  relocate('food_V2_ID', 'orig_food_common_name', .before = Ingredient_code) %>%
  select(-Ingredient_description)
```


### 1) Match ASA to WWEIA Codes

Link matched ASA/FooDB matched descriptions. Result is ingredientized ASA matched to FooDB.
```{r}
ASA = left_join(ingredients, matched, by = 'Ingredient_code') %>%
  relocate(Ingredient_code, Ingredient_description, food_id, food_V2_ID, 
           orig_food_common_name, mean_score, .after = Food_Description) %>%
  left_join(WWEIAcodes, by = 'WWEIA.Category.number') %>%
  relocate(RecallNo, .after = UserName) %>%
  select(-c(food_V2_ID, orig_food_id, fndds_description, IntakeStartDateTime, 
            IntakeEndDateTime, RecallAttempt))
```


Isolate relevant columns 
Food matrix classifications
```{r}
unique.ASA.foods = ASA %>%
  select(c(FoodCode, Food_Description, Ingredient_code, Ingredient_description, 
           WWEIA.Category.number, Food_Subcategory, Category, Form,
           food_id, orig_food_common_name)) %>%
  distinct(FoodCode, Ingredient_code, .keep_all = TRUE) 
```


### 2) Isolate some special patterns

Salad Dressings and Oils
```{r}
cat8012 = unique.ASA.foods %>%
  filter(WWEIA.Category.number == 8012) %>%
  mutate(Form = if_else(FoodCode %in% c(83300600, 82104000, 82107000, 82102000, 
                                        821005500, 82101000),  'Liquid', 'Semi-Solid'))
```

Mixed foods + Honey (91302010)
```{r}
mixedfoods = unique.ASA.foods %>%
  filter(WWEIA.Category.number %in% c(3102, 3104, 3002, 3004, 3006, 8802)) %>%
  mutate(Form = if_else(FoodCode %in% c(58160110, 75440600, 27116100,
                                        27146150, 28355440, 91302010),  'Semi-Solid', 'Solid'))
```

Other Category
```{r}
cat9999 = unique.ASA.foods %>%
  filter(WWEIA.Category.number == 9999) %>%
  mutate(Form = if_else(FoodCode %in% c(99997550, 89901050),  'Semi-Solid', 
                        if_else(FoodCode %in% c(11813000, 11830165), 'Liquid', 'Solid')))
```

```{r}
cat3802 = unique.ASA.foods %>%
  filter(WWEIA.Category.number == 3802) %>%
  mutate(Form = if_else(FoodCode %in% c(28340640, 28317010, 28315050),  'Solid', 'Semi-Solid'))
```


### 3) Merge everything back together

```{r}
merged = unique.ASA.foods %>%
  filter(!FoodCode %in% c(cat8012$FoodCode, mixedfoods$FoodCode, cat9999$FoodCode, 
                          cat3802$FoodCode)) %>%
  full_join(cat8012) %>%
  full_join(cat3802) %>%
  full_join(cat9999) %>%
  full_join(mixedfoods) %>%
  mutate(FoodMatrix = factor(Form)) %>%
  select(-Form)

write.csv(merged, 'data/ASA_FooDB_Food_Matrix.csv', row.names = FALSE)
```





