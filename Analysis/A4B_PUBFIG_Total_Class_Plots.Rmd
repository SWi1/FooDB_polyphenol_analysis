---
title: "PUBFIG_Total_Class_RegressionPlots"
author: "Stephanie Wilson"
date: "November 2023"
output: html_document
---

# Create heatmap and regression plots for total and class analyses

__Required Input Files__.                          
  - *FL100_PP_Raw.csv* - Polyphenol content for each compound in foods listed in each recall test. Output from A0_FilePrep_Exploration.Rmd.
  - *FooDB_phenols_taxonomy.csv* - Output from A0A_Scrape_Taxonomy.Rmd
  - *FooDB_phenol_content_DailyClassAvg.csv* - Output from A4_Class_Analyses.Rmd, Average Intake for every compound from each Participant
  - *FL100_merged_variables.csv* - Compilation of FL100 variables from A0_Merge_Variables.Rmd
  - *All_ANCOVA_results.csv* - Output from A3_Class_Analyses.Rmd
  - *Heatmap RDS files* - Output from A3_Total_Analyses_Inflammation.Rmd, A4A_PUBFIG_Class_Heatmap.Rmd
  
  
__Outputs__
  - Total Polyphenol Analysis Plots
  - Class Polyphenol Analysis Plots
  
```{r Load packages, message = FALSE}
library(tidyverse); library(ggpubr); library(bestNormalize); library(smplot2)
```


```{r Load Data}
#Define compound outliers
removal_list = factor(c('Chinese tannin', 'alpha-Viniferin'))

PP_Raw = read.csv('data/FL100_PP_Raw.csv') %>%
  filter(!compound_name %in% removal_list) %>%
  mutate(RecallNo = factor(RecallNo))

#Intakes by class
class = read.csv('FooDB/FooDB_phenol_content_DailyClassAvg.csv')

#multiple files including ASA averages for kcal and fiber
merged = read.csv('data/FL100_merged_variables.csv') %>%
  mutate(Sex = factor(Sex))

tax = read.csv('FooDB/FooDB_phenols_taxonomy.csv')
```

Class Data Load and Clean
```{r}
ANCOVA = read.csv('output/All_ANCOVA_results.csv') %>%
  filter(Outcome=='LBP' & Class %in% c('Prenol lipids', 'Phenylpropanoic acids')) %>%
  filter(Variable %in% c('(Intercept)', 'Polyphenol Class Intake')) 

#Isolate Intercepts
Intercepts = ANCOVA %>%
  filter(Variable == ('(Intercept)')) %>%
  select(c(diet_control, Class, Coefficient)) %>%
  rename('Intercept' =3 )

ANCOVA_filter = ANCOVA %>%
  filter(!Variable == ('(Intercept)')) %>%
  left_join(Intercepts)
```


### 1) Total Intake Figure

Sum polyphenol intake (mg) consumed for each recall, for each person, then averaged across recalls.
 - No compound or food clarity.
```{r}
total_daily_intake = PP_Raw %>%
  group_by(UserName, RecallNo) %>%
  mutate(total_daily_intake_mg = sum(pp_consumed, na.rm = TRUE)) %>%
  select(c(UserName, RecallNo, total_daily_intake_mg)) %>%
  ungroup() %>%
  group_by(UserName) %>%
  mutate(Avg_Total_Daily_PP_Intake_mg = mean(total_daily_intake_mg)) %>%
  distinct(UserName, .keep_all = TRUE) %>%
  select(-c(RecallNo, total_daily_intake_mg)) %>%
  left_join(merged, by = 'UserName') %>%
  arrange(UserName) %>%
  relocate(Sex, After24h, .after = UserName) %>%
  mutate(energy_adj_Avg_Total_Daily_PP = Avg_Total_Daily_PP_Intake_mg/
           (avg_total_kcal/1000)) 
```


```{r}
calprotectin = total_daily_intake %>%
  filter(!is.na(fecal_calprotectin))

#Plot
total_plot = ggscatter(calprotectin, x = "energy_adj_Avg_Total_Daily_PP", y = "fecal_calprotectin") +
 coord_cartesian(ylim = c(min(calprotectin$fecal_calprotectin), max(calprotectin$fecal_calprotectin)))+ 
  geom_abline(intercept = 55.1396088, slope = -0.0039462, color = "black", size = 1.2)+
  annotate("text", x =8000, y = max(calprotectin$fecal_calprotectin)*0.8,
           label = bquote(atop(beta == .(-0.004), p == 0.036)), 
           vjust = 1.5, hjust = 1) +
  
  labs(y = 'CAL (ng/mL)', x = 'Total Polyphenol Intake\n(mg/1000 kcal)') + 
    theme(plot.margin = unit(c(0,0.5,0.5,0.5), "cm"),
          axis.text.x = element_text(angle = 45,vjust = 1, hjust = 1)) 
total_plot
```



Merge with Heatmap
```{r}
heatmap_total = readRDS('images/Heatmap_TotalPP.rds')

combined_total = ggarrange(heatmap_total, total_plot, ncol = 2, widths = c(2.3,1), labels = c("A)", "B)"), align = 'v')
 combined_total
 
#For publications
ggsave(combined_total, filename = 'images/Heatmap_TotalPP_2panel.pdf', height = 3, width = 8, units = 'in')
ggsave(combined_total, filename = 'images/Heatmap_TotalPP_2panel.jpg', height = 3, width = 8, units = 'in') 
```


### 2) Class Intake Figure
Filter in Prenol lipids and phenylpropanoic acids. Format to long format for plotting, clean up class names.
```{r}
sigclass = total_daily_intake %>%
  filter(!is.na(plasma_lbp_bd1))%>%
  left_join(class, by = "UserName") %>%
  select(c(UserName, avg_total_kcal, plasma_lbp_bd1, Prenol.lipids, Phenylpropanoic.acids)) %>%
  pivot_longer(cols =4:5, names_to = 'class', values_to = 'value') %>% 
  mutate(class = case_when(
   class == 'Prenol.lipids' ~ 'Prenol Lipids',
    class == 'Phenylpropanoic.acids' ~ 'Phenylpropanoic Acids'))

value_transformed = data.frame(value_transformed = yeojohnson(sigclass$value)$x.t)

sigclass_update = cbind(sigclass, value_transformed)
```


```{r}
facet_specific_lines = ANCOVA_filter %>%
  select(c(diet_control, Class, Intercept, Coefficient, P_Value))

#Class plots
class_plots = ggscatter(sigclass_update, x = "value", y = "plasma_lbp_bd1", add = "reg.line") +
  facet_wrap(~str_wrap(class, width =25), scales = 'free_x', ncol=5) +
  coord_cartesian(ylim = c(min(sigclass$plasma_lbp_bd1), max(sigclass$plasma_lbp_bd1)*1.2))+
   stat_cor(method = 'spearman', p.accuracy = 0.001,
           label.x.npc = 'left', label.y = max(sigclass$plasma_lbp_bd1)*1.1, size =3) +
  labs(y = expression("LBP (Âµg/mL)"), x = 'Class Intake (Yeo-Johnson transformed)')+ 
    theme(plot.margin = unit(c(0,0,0,0.5), "cm")) 

class_plots
```


### 3) Combine with ANCOVA Heat map
```{r}
heatmaps = readRDS("images/Heatmap_ClassPP.rds")
combined_plot = ggarrange(heatmaps, class_plots, nrow = 2, heights = c(3,1),labels = c("A)", "B)"),vjust = c(2, 0))
 combined_plot
 
#For publications
ggsave(combined_plot, filename = 'images/Heatmap_Class_2panel.pdf', height = 7, width = 8, units = 'in')
ggsave(combined_plot, filename = 'images/Heatmap_Class_2panel.jpg', height = 7, width = 8, units = 'in', dpi = 300) 
```

