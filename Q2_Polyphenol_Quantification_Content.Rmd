---
title: "Q2_Polyphenol_Quantification_Content"
author: "Stephanie Wilson"
date: "`r Sys.Date()`"
output: html_document
---


# Polyphenol Quantification
## Step 2: Preparation of Phenol Content File

__Required Input Files__  
  - *FooDB_phenols.csv* - output from Q1_Polyphenol_Quantification_FooDB_PhenolID.Rmd
  - *Food_V2_descripcleaned.csv* - output from 02_FooDB_TextProcessing.ipynb
  - *Content.csv.* - FooDB data (version 1) downloaded Sept 2022 from FooDB.ca/downloads
  - *Content_updated.csv* - output from 01_FooDB_FooDBCleaning.ipynb
  - *Food_updated.csv* - 01_FooDB_FooDBCleaning.ipynb

__Information__  
This script prepares the Content file with cleaned text descriptions and merges this information with our phenol list. The output is ready to be matched with dietary recall data.

  1) Replace Content_updated food descriptions with cleaned text descriptions
  2) Add endogenous compounds back into Content_updated
  3) Merge phenol compound data with Content_updated with cleaned food descriptions
     - Important Note: Content file needs to be filtered for source_type=='Compounds'
  4) Unit Check    

__Outputs__  
  - *FooDB_phenol_premerge.csv.bz2* - Pre-averaged content values for retention factor matching
  
```{r Load packages, message=FALSE}
library(tidyverse)
```


```{r Load data}
# Load FooDB phenols
FooDB_phenols = read.csv('FooDB/FooDB_phenols.csv', header=TRUE)

# Load cleaned text FooDB descriptions
Food_V2 = read.csv("FooDB/Food_V2_descripcleaned.csv", header=TRUE) %>%
  select(c(orig_food_common_name, food_V2_ID))

# Load FooDB data
# Original Content File needed for adding endogenous compounds back in
Content_updated = read.csv('FooDB/Content_updated.csv.bz2', header=TRUE)
Content = read.csv("FoodB/Content.csv.bz2", header=TRUE) %>% 
  filter(!orig_food_common_name == 'Lipid from Arabidopsis (PathBank)') %>%
  filter(!food_id == 16420)

#Load updated FooDB Food ID's
Food = read.csv('FooDB/Food_updated.csv') %>%
  select(c(id, name, public_id)) %>%
  dplyr::rename('food_id' = 'id',
         'food_name' = 'name',
         'food_public_id' = 'public_id')
```


### 1) Replace food descriptions with cleaned text descriptions
```{r}
#match food_V2_ids, then replace old desription with new
Content_updated[["new_descrip"]] = Food_V2[match(Content_updated[['food_V2_ID']], Food_V2[['food_V2_ID']]), 'orig_food_common_name']

#delete old food descriptions, 
#rename new_id to orig_food_common_name
Content_updated = Content_updated %>% 
  select(-c('orig_food_common_name')) %>%
  dplyr::rename(orig_food_common_name = new_descrip) %>%
  relocate(c('orig_food_common_name', 'preparation_type', 
             'food_V2_ID'), .after = orig_food_id)
```


### 2) Add endogenous compounds back into Contents_updated to recreate Content file
We had previously removed Pathbank and endogenous compound (HMDB) entries from Content.csv in in 01_FooDB_FooDBCleaning.ipynb. Based on our exploration of phenol matches in Q1_Polyphenol_Quantification_FooDB_PhenolID.Rmd, we know that none of the 3080 polyphenolic compounds have entries related to Pathbank. However, several polyphenolic compounds had an endogenous description, so we need to add endogenous compounds back in. We will also give them a food id, 9914.

```{r message=FALSE}
#Identify the Endogenous Compounds
Endogenous = anti_join(Content, Content_updated, by = 'id') %>% 
  mutate(food_V2_ID = 9914)

# Add endogenous back into Content_updated
# We will keep out items from HMDB
Content = full_join(Content_updated, Endogenous)
```


### 3) Merge phenol compound data with Content Data with cleaned food descriptions

Content first needs to be filtered for source_type=='Compounds' which is where you'll find polyphenols. 
  - source_type == 'Nutrients' retrieves 'classical nutrients' in dietary reporting
  
```{r Merge phenol Compound data with Content Data}
#Filter for compounds
Content_filtered = Content %>% 
  filter(source_type == 'Compound')
```

Let us merge and clean our file for export. 
```{r}
FooDB_phenol_content = Content_filtered %>%
  filter(source_id %in% FooDB_phenols$id) %>%
  left_join(FooDB_phenols, by = c('source_id' = 'id')) %>%
  left_join(Food, by = 'food_id') %>%
  relocate('food_name', 'orig_food_part', 'food_public_id', .after = 'food_id') %>%
  select(-c(state, moldb_iupac, cas_number, description, moldb_inchi,
            moldb_inchikey, moldb_smiles, moldb_mono_mass, kingdom, klass, 
            superklass, subklass, annotation_quality,
            source_type)) %>% #remove Compound columns
  select(-c(id, orig_food_scientific_name,  
            orig_citation, creator_id, updater_id, 
            created_at, updated_at,  orig_unit_expression)) %>% #Remove Content columns
  dplyr::rename('compound_id' = 'source_id',
         'compound_name' = 'name',
         'compound_public_id' = 'public_id') %>%
  relocate(compound_id, compound_public_id, compound_name, .before = orig_content) %>%
  arrange(food_id)
```


It appears a soy entry slipped through an earlier cleaning step. Quickly correct and replace in content file.
```{r}
soy = FooDB_phenol_content %>% 
  filter(food_id == 16420) %>% 
  mutate(food_id = 272,
         food_name = 'Other soy product',
         food_public_id = 'FOOD00271')

FooDB_phenol_content = FooDB_phenol_content %>%
  filter(!food_id == 16420) %>%
  add_row(soy)
```


### 4) Unit Check
```{r}
table(FooDB_phenol_content$orig_unit)
```
SW Update:  
Manually cross-checked a random assortment of polyphenol entries with citation reference across several unit types. It appears 'orig_content' entries reflect mg/100 mg values and not units presented in orig_unit.
 - *FooDB Error*: where orig_unit == 'mg/kg', online FooDB.ca are in mg/g values but are reported as mg/100g.
  
Let us write our current version out so we can add in retention factors in another script.
```{r}
write.csv(FooDB_phenol_content, 'FooDB/FooDB_phenol_premerge.csv.bz2', row.names = FALSE)
```
